name: OpenAPI Dependabot

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  update-openapi-specs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout api-specs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: 2201.10.0
      
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      - name: Run Dependabot Monitor
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd dependabot
          bal run
          cd ..
      
      - name: Create and Push Branch with PR
        if: hashFiles('UPDATE_SUMMARY.txt') != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Generate branch name with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="openapi-update-${TIMESTAMP}"
          
          echo "üìã Changes detected, creating branch: ${BRANCH_NAME}"
          
          # Create and checkout new branch
          git checkout -b "${BRANCH_NAME}"
          
          # Add changed files
          git add specs/ repos.json UPDATE_SUMMARY.txt
          
          # Create commit message
          UPDATE_SUMMARY=$(cat UPDATE_SUMMARY.txt)
          COMMIT_MSG="chore: Update OpenAPI specifications

          ${UPDATE_SUMMARY}

          Automated update by OpenAPI Dependabot"
          
          # Commit and push
          git commit -m "${COMMIT_MSG}"
          git push -u origin "${BRANCH_NAME}"
          
          echo "‚úÖ Branch pushed successfully"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
      
      - name: Create Pull Request
        if: hashFiles('UPDATE_SUMMARY.txt') != '' && env.BRANCH_NAME != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Read update summary
          UPDATE_SUMMARY=$(cat UPDATE_SUMMARY.txt)
          
          # Create PR title and body
          PR_TITLE="Update OpenAPI Specifications - $(date +%Y-%m-%d)"
          PR_BODY="## OpenAPI Specification Updates

          This PR contains automated updates to OpenAPI specifications detected by the Dependabot monitor.

          ### Changes:
          ${UPDATE_SUMMARY}

          ### Checklist:
          - [ ] Review specification changes
          - [ ] Verify connector generation works
          - [ ] Run tests
          - [ ] Update documentation if needed

          ---
          ü§ñ This PR was automatically generated by the OpenAPI Dependabot"
          
          # Create PR using GitHub API
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls \
            -d "$(jq -n \
              --arg title "$PR_TITLE" \
              --arg body "$PR_BODY" \
              --arg head "$BRANCH_NAME" \
              --arg base "main" \
              '{title: $title, body: $body, head: $head, base: $base}')")
          
          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
          
          if [ "$PR_URL" != "null" ] && [ -n "$PR_URL" ]; then
            echo "‚úÖ Pull Request created successfully!"
            echo "üîó PR URL: ${PR_URL}"
            
            # Add labels
            if [ "$PR_NUMBER" != "null" ]; then
              curl -s -X POST \
                -H "Authorization: token ${GH_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/labels \
                -d '{"labels":["openapi-update","automated","dependencies"]}' > /dev/null
              echo "üè∑Ô∏è  Added labels to PR"
            fi
          else
            echo "‚ùå Failed to create Pull Request"
            echo "Response: $PR_RESPONSE"
            exit 1
          fi
          
          # Cleanup
          rm -f UPDATE_SUMMARY.txt