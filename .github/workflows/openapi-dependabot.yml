name: OpenAPI Dependabot

on:
  schedule:
    - cron: "0 2 * * *"  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggers

jobs:
  update-openapi-specs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout api-specs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: 2201.10.0
      
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      - name: Run Dependabot Monitor
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd dependabot
          bal run
          cd ..
      
      - name: Check for updates
        id: check_updates
        run: |
          if [ -f "UPDATE_SUMMARY.txt" ]; then
            echo "updates_found=true" >> $GITHUB_OUTPUT
            echo "üìã Updates detected!"
          else
            echo "updates_found=false" >> $GITHUB_OUTPUT
            echo "‚ú® No updates found"
          fi
      
      - name: Create and Push Branch
        if: steps.check_updates.outputs.updates_found == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="openapi-update-${TIMESTAMP}"
          echo "üìã Creating branch: ${BRANCH_NAME}"
          git checkout -b "${BRANCH_NAME}"
          git add openapi/ repos.json UPDATE_SUMMARY.txt
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit"
            exit 0
          fi
          UPDATE_SUMMARY=$(cat UPDATE_SUMMARY.txt)
          COMMIT_MSG="chore: Update OpenAPI specifications\n\n${UPDATE_SUMMARY}\n\nAutomated update by OpenAPI Dependabot"
          git commit -m "$COMMIT_MSG"
          git push -u origin "$BRANCH_NAME"
          echo "‚úÖ Branch pushed successfully"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
      - name: Ensure Labels Exist
        if: steps.check_updates.outputs.updates_found == 'true' && env.BRANCH_NAME != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Create labels if they don't exist
          gh label create "openapi-update" --description "OpenAPI specification updates" --color "0366d6" --force
          gh label create "automated" --description "Automated changes" --color "bfd4f2" --force
          gh label create "dependencies" --description "Dependency updates" --color "0366d6" --force
      - name: Create Pull Request
        if: steps.check_updates.outputs.updates_found == 'true' && env.BRANCH_NAME != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          UPDATE_SUMMARY=$(cat UPDATE_SUMMARY.txt)
          PR_TITLE="chore: Update OpenAPI Specifications - $(date +%Y-%m-%d)"
          PR_BODY="## OpenAPI Specification Updates\n\nThis PR contains automated updates to OpenAPI specifications detected by the Dependabot monitor.\n\n### Changes:\n${UPDATE_SUMMARY}\n\n### Structure:\nAll specifications follow the standard structure:\n- openapi/{vendor}/{api}/{version}/openapi.yaml\n- openapi/{vendor}/{api}/{version}/.metadata.json\n\n### Checklist:\n- Review specification changes\n- Verify connector generation works\n- Run tests\n- Update documentation if needed\n\n---\nü§ñ This PR was automatically generated by the OpenAPI Dependabot"
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "openapi-update,automated,dependencies"
          echo "‚úÖ Pull Request created successfully!"
          rm -f UPDATE_SUMMARY.txt

      - name: Trigger Connector Regeneration
        if: steps.check_updates.outputs.updates_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "üöÄ Triggering connector regeneration..."
          
          # Check if UPDATE_SUMMARY.txt exists
          if [ ! -f "UPDATE_SUMMARY.txt" ]; then
            echo "‚ö†Ô∏è UPDATE_SUMMARY.txt not found, skipping connector triggers"
            exit 0
          fi
          
          # Read all updated specs from UPDATE_SUMMARY.txt
          while IFS= read -r line; do
            # Parse format: "- vendor/api: oldver ‚Üí newver (API vXXX)"
            if echo "$line" | grep -q "^-"; then
              # Extract vendor/api part (between "- " and ":")
              SPEC_PATH=$(echo "$line" | sed 's/^- \(.*\):.*/\1/' | xargs)
              VENDOR=$(echo "$SPEC_PATH" | cut -d'/' -f1)
              API=$(echo "$SPEC_PATH" | cut -d'/' -f2)
              API=$(echo "$SPEC_PATH" | cut -d'/' -f2)
              
              # Find connector repo from repos.json
              CONNECTOR_REPO=$(jq -r ".[] | select(.vendor==\"$VENDOR\" and .api==\"$API\") | .connectorRepo" repos.json)
              
              if [ -n "$CONNECTOR_REPO" ] && [ "$CONNECTOR_REPO" != "null" ]; then
                echo "üì° Triggering update for $CONNECTOR_REPO"
                
                # Get spec version and URL
                VERSION=$(jq -r ".[] | select(.vendor==\"$VENDOR\" and .api==\"$API\") | .lastVersion" repos.json)
                SPEC_URL="https://raw.githubusercontent.com/api-specs-test/api-specs/main/openapi/${VENDOR}/${API}/${VERSION}/openapi.yaml"
                
                # Trigger repository_dispatch event
                gh api repos/"$CONNECTOR_REPO"/dispatches \
                  -f event_type=openapi-update \
                  -f "client_payload[openapi_url]=$SPEC_URL" \
                  -f "client_payload[spec_version]=$VERSION" \
                  -f "client_payload[vendor]=$VENDOR" \
                  -f "client_payload[api]=$API"
                
                echo "‚úÖ Triggered for $CONNECTOR_REPO"
              else
                echo "‚ö†Ô∏è  No connector repo found for $VENDOR/$API"
              fi
            fi
          done < UPDATE_SUMMARY.txt
          
          echo "‚úÖ All connector regenerations triggered!"